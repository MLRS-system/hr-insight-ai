<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>HR Insight AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Maru+Buri:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            font-family: 'Maru Buri', sans-serif;
            background-color: #ffffff;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100vh;
        }
        .content-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }
        .input-box-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .input-box {
            border: 10px solid #212529; /* 요청하신 대로 굵은 테두리 */
            width: 100%;
            max-width: 600px;
            background-color: #f8f9fa;
        }
        #prompt-textarea {
            height: 200px;
            border: none;
            resize: none;
            box-shadow: none;
            background-color: transparent;
            font-size: 1.25rem;
            padding: 1.5rem;
            text-align: center;
        }
        .upload-area {
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
        }
        .url-input-area {
            height: 75px;
        }
        #file-upload-label {
            cursor: pointer;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="/">HR Insight AI</a>
            </div>
        </nav>

        <main class="content-wrapper">
            <div class="container text-center">
                
                <div id="prompt-step">
                    <div class="input-box-wrapper mb-4">
                        <div class="input-box">
                            <textarea id="prompt-textarea" class="form-control" placeholder="분석 요청 내용을 입력하고 Enter를 누르세요"></textarea>
                        </div>
                    </div>
                    <h2>사용자 프롬프트를 입력해 주세요</h2>
                    <p class="lead text-muted">사용자의 의도, 바라는 결과물을 명확하게 써주시면 좋습니다.</p>
                </div>

                <div id="file-step" style="display: none;">
                    <div class="input-box-wrapper mb-3">
                        <div class="input-box upload-area">
                            <label for="file-upload" id="file-upload-label" class="form-label text-muted m-0">
                                파일을 첨부하려면 여기를 클릭하세요
                            </label>
                            <input type="file" id="file-upload" class="form-control" style="display: none;">
                        </div>
                    </div>
                    <div class="input-box-wrapper">
                        <div class="input-box url-input-area">
                            <input type="text" id="url-input" class="form-control border-0 bg-transparent h-100 text-center" placeholder="또는 URL을 여기에 입력하세요">
                        </div>
                    </div>
                    <h2 class="mt-4">분석하고 싶은 콘텐츠를 선택해주세요.</h2>
                    <p class="lead text-muted">준비가 되면 아래의 '분석 시작' 버튼을 눌러주세요.</p>
                    <button class="btn btn-primary btn-lg mt-4" type="button" id="analysis-start-btn">분석 시작</button>
                </div>
                
                <div id="result-step" style="display: none;">
                    <div id="status-container" class="mb-4">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                        <p id="status-log" class="lead mt-3 text-muted"></p>
                    </div>
                    <div id="report-container" class="mt-4 text-start" style="display: none;">
                        <h2 class="text-center mb-4">최종 분석 보고서</h2>
                        <pre id="final-report" class="border p-4 bg-light" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                        <div class="text-center mt-4">
                            <button id="download-btn" class="btn btn-secondary">보고서 다운로드 (txt)</button>
                            <a href="/" class="btn btn-light ms-2">새로 시작하기</a>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <footer class="py-5 bg-dark">
            <div class="container"><p class="m-0 text-center text-white">Copyright &copy; HR Insight AI 2025</p></div>
        </footer>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Element references
        const promptStep = document.getElementById('prompt-step');
        const fileStep = document.getElementById('file-step');
        const resultStep = document.getElementById('result-step');
        const promptTextarea = document.getElementById('prompt-textarea');
        const fileInput = document.getElementById('file-upload');
        const fileUploadLabel = document.getElementById('file-upload-label');
        const analysisStartBtn = document.getElementById('analysis-start-btn');
        const statusContainer = document.getElementById('status-container');
        const statusLog = document.getElementById('status-log');
        const reportContainer = document.getElementById('report-container');
        const finalReport = document.getElementById('final-report');
        const downloadBtn = document.getElementById('download-btn');

        let pollingInterval;

        // "Enter" key press on prompt textarea triggers the next step
        promptTextarea.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const userRequest = promptTextarea.value;
                if (!userRequest.trim()) {
                    alert('요청사항을 입력해주세요.');
                    return;
                }
                // Store the prompt in the browser's temporary storage
                localStorage.setItem('userRequest', userRequest);
                promptStep.style.display = 'none';
                fileStep.style.display = 'block';
            }
        });

        // Update label text when a file is chosen
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileUploadLabel.textContent = fileInput.files[0].name;
                fileUploadLabel.classList.remove('text-muted');
                fileUploadLabel.classList.add('text-dark');
            } else {
                fileUploadLabel.textContent = '파일을 첨부하려면 여기를 클릭하세요';
                fileUploadLabel.classList.add('text-muted');
                fileUploadLabel.classList.remove('text-dark');
            }
        });

        // Event listener for the "Start Analysis" button
        analysisStartBtn.addEventListener('click', async () => {
            // Retrieve the stored prompt from the browser's storage
            const userRequest = localStorage.getItem('userRequest');
            const urlInput = document.getElementById('url-input').value;

            if (!userRequest) {
                alert('오류: 요청사항이 없습니다. 새로고침 후 다시 시도해주세요.');
                return;
            }
            if (!fileInput.files[0] && !urlInput.trim()) {
                alert('분석할 파일이나 URL을 입력해주세요.');
                return;
            }

            fileStep.style.display = 'none';
            resultStep.style.display = 'block';
            reportContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            statusLog.textContent = '서버에 분석을 요청하는 중...';
            
            const formData = new FormData();
            formData.append('user_request', userRequest);
            formData.append('url', urlInput);
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }

            try {
                const response = await fetch('/run-analysis', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                const jobId = data.job_id;

                if (jobId) {
                    pollingInterval = setInterval(() => checkStatus(jobId), 3000);
                } else {
                    statusLog.textContent = `오류: 분석 작업을 시작하지 못했습니다. (${data.error || ''})`;
                }
            } catch (error) {
                statusLog.textContent = `오류: 서버와 통신할 수 없습니다. ${error}`;
            }
        });

        // Function to poll for status updates
        async function checkStatus(jobId) {
            try {
                const response = await fetch(`/status/${jobId}`);
                const data = await response.json();
                
                const lastHistory = data.history.length > 0 ? data.history[data.history.length - 1] : null;
                statusLog.textContent = lastHistory ? `[${lastHistory.agent}] - ${lastHistory.action}` : '작업을 시작하는 중...';

                if (data.status === '완료' || data.status === '오류 발생') {
                    clearInterval(pollingInterval);
                    statusContainer.style.display = 'none';
                    reportContainer.style.display = 'block';

                    if (data.status === '완료') {
                        const resultResponse = await fetch(`/result/${jobId}`);
                        const resultData = await resultResponse.json();
                        finalReport.textContent = resultData.result;
                    } else {
                        finalReport.textContent = `오류가 발생했습니다:\n\n${data.result}`;
                    }
                }
            } catch (error) {
                statusLog.textContent = '오류: 상태를 확인하는 중 문제가 발생했습니다.';
                clearInterval(pollingInterval);
            }
        }

        // Function to download the report
        downloadBtn.addEventListener('click', () => {
            const text = finalReport.textContent;
            const filename = 'HR_Insight_Report.txt';
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        });
    </script>
</body>
</html>